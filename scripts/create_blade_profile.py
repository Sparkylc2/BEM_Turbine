import math

from create_blade_functions import *


# ---------------------------------------------------------------------------------------------------------------- #
# ------------------------------------------------- ROTOR CONFIG ------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- #
# ------------------------ TSR ----------------------- #
# ---------------------------------------------------- #
TSR = 3.5
# ---------------------------------------------------- #
# -------------------- HUB RADIUS -------------------- #
# ---------------------------------------------------- #
HUB_RADIUS = 0.0 # metres
# ---------------------------------------------------- #
# -------------------- TIP RADIUS -------------------- #
# ---------------------------------------------------- #
TIP_RADIUS = 3.0 # metres
# ---------------------------------------------------- #
# ------------------ FREE STREAM VEL ----------------- #
# ---------------------------------------------------- #
WIND_SPEED = 10.0 # metres per second
# ---------------------------------------------------- #
# -------------------- NUM BLADES -------------------- #
# ---------------------------------------------------- #
NUM_BLADES = 2
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #


# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- BLADES ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------- PROFILE RESOLUTION ---------------- #
# ---------------------------------------------------- #
PROFILE_RESOLUTION = 2
# ---------------------------------------------------- #
# ------------- CHORD/TWIST DISTRIBUTION ------------- #
# ---------------------------------------------------- #
CHORD_DISTRIBUTION = lambda r:  8 * math.pi * r / (2 * 1.415) * (1 - math.cos(TWIST_DISTRIBUTION(r)))
TWIST_DISTRIBUTION = lambda r: 2.0 / 3.0 * math.atan(1.0 / 3.5)
# ---------------------------------------------------- #
# ---------------- TWIST DISTRIBUTION ---------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# --------------- PROFILE DISTRIBUTION --------------- #  this will consist of the key profiles, the rest will be
# ---------------------------------------------------- #  filled in based on resolution. Non dimensionalize radial
INITIAL_PROFILES = []                                  #  position here (easy scaling) (also 0 means hub, 1 means tip)

INITIAL_PROFILES.append({"coordinate_file": "SG6043", "radial_pos": 0.2})
INITIAL_PROFILES.append({"coordinate_file": "SG6043", "radial_pos": 1.0})
# ---------------------------------------------------- #
# --------------- EXTRA CONFIG PARAMS ---------------- #
# ---------------------------------------------------- #
# you should only need to touch this, but just in case
radial_position_uses_nondimensional_radius = True
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #




# ---------------------------------------------------------------------------------------------------------------- #
# --------------------------------------------------- ROUTINE ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- #
# --------------- CREATE BLADES ARRAY  --------------- #
# ---------------------------------------------------- #
profiles = np.array(generate_even_profiles(INITIAL_PROFILES, PROFILE_RESOLUTION))

blades = list(map(lambda profile: Blade(
    radial_pos_m    =                    profile["radial_pos"]      if not radial_position_uses_nondimensional_radius else profile["radial_pos"] * (TIP_RADIUS - HUB_RADIUS),
    chord_len_m     = CHORD_DISTRIBUTION(profile["radial_pos"]),
    twist_rad       = TWIST_DISTRIBUTION(profile["radial_pos"]),
    naca            =                    profile["naca"]            if "naca"            in profile else "",
    coordinate_file =                    (profile["coordinate_file"] if "coordinate_file" in profile else "").strip() + (".dat" if not profile["coordinate_file"].endswith(".dat") else "")
), profiles))

# ---------------------------------------------------- #
# ------------- CREATE BLADE PROFILE OBJ ------------- #
# ---------------------------------------------------- #
blade_profile = BladeProfile(
    blades = blades,
    rotor_hub_radius_m = HUB_RADIUS,
    rotor_radius_m = TIP_RADIUS,
    num_blades = NUM_BLADES,
    tip_speed_ratio = TSR,
    wind_speed_mps = WIND_SPEED
)

# ---------------------------------------------------- #
# -------------- SAVE BLADE PROFILE OBJ -------------- #
# ---------------------------------------------------- #
save_blade_profile_json(blade_profile, 'blade_profile_test')
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #



