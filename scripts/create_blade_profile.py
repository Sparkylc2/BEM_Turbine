import math

from create_blade_functions import *


# ---------------------------------------------------------------------------------------------------------------- #
# ------------------------------------------------- ROTOR CONFIG ------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- #
# ------------------------ TSR ----------------------- #
# ---------------------------------------------------- #
TSR = 3.5
# ---------------------------------------------------- #
# -------------------- HUB RADIUS -------------------- #
# ---------------------------------------------------- #
HUB_RADIUS = 0.02 # metres
# ---------------------------------------------------- #
# -------------------- TIP RADIUS -------------------- #
# ---------------------------------------------------- #
TIP_RADIUS = 0.227 # metres
# ---------------------------------------------------- #
# ------------------ FREE STREAM VEL ----------------- #
# ---------------------------------------------------- #
WIND_SPEED = 10.0 # metres per second
# ---------------------------------------------------- #
# -------------------- NUM BLADES -------------------- #
# ---------------------------------------------------- #
NUM_BLADES = 2
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #


# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- BLADES ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------- PROFILE RESOLUTION ---------------- #
# ---------------------------------------------------- #
PROFILE_RESOLUTION = 20
# ---------------------------------------------------- #
# ------------- CHORD/TWIST DISTRIBUTION ------------- #
# ---------------------------------------------------- #
CHORD_DISTRIBUTION = lambda r:  8 * math.pi * r / (NUM_BLADES * CL_DES) * (1 - math.cos(PHI_DISTRIBUTION(r)))
PHI_DISTRIBUTION = lambda r: 2.0 / 3.0 * math.atan(1.0 / (TSR * r/TIP_RADIUS))
TWIST_DISTRIBUTION = lambda r: (PHI_DISTRIBUTION(r) - A_DES) * 30/46

# ---------------------------------------------------- #
# ------------------ DESIGN PARAMS ------------------- #
# ---------------------------------------------------- #
A_DES = math.radians(2.25)
CL_DES = 1.012
SHIFT = (1 - 0.321, -0.05, 0.0)
# ---------------------------------------------------- #
# --------------- PROFILE DISTRIBUTION --------------- #  this will consist of the key profiles, the rest will be
# ---------------------------------------------------- #  filled in based on resolution. Non dimensionalize radial
INITIAL_PROFILES = []                                  #  position here (easy scaling) (also 0 means hub, 1 means tip)

INITIAL_PROFILES.append({"coordinate_file": "SG6043.dat", "radial_pos": 0.0})
INITIAL_PROFILES.append({"coordinate_file": "SG6043.dat", "radial_pos": 1.0})
# ---------------------------------------------------- #
# --------------- EXTRA CONFIG PARAMS ---------------- #
# ---------------------------------------------------- #
# you should only need to touch this, but just in case
radial_position_uses_nondimensional_radius = True
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #




# ---------------------------------------------------------------------------------------------------------------- #
# --------------------------------------------------- ROUTINE ---------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------- #
# --------------- CREATE BLADES ARRAY  --------------- #
# ---------------------------------------------------- #
profiles = np.array(generate_even_profiles(INITIAL_PROFILES, PROFILE_RESOLUTION))

blades = list(map(lambda profile: Blade(
    radial_pos_m    =                    profile["radial_pos"] * (TIP_RADIUS - HUB_RADIUS) + HUB_RADIUS,
    chord_len_m     = CHORD_DISTRIBUTION(profile["radial_pos"] * (TIP_RADIUS - HUB_RADIUS) + HUB_RADIUS),
    twist_rad       = TWIST_DISTRIBUTION(profile["radial_pos"] * (TIP_RADIUS - HUB_RADIUS) + HUB_RADIUS),
    naca            =                    profile["naca"]            if "naca"            in profile else "",
    coordinate_file =                    profile["coordinate_file"] if "coordinate_file" in profile else ""
), profiles))

# ---------------------------------------------------- #
# ------------- CREATE BLADE PROFILE OBJ ------------- #
# ---------------------------------------------------- #
blade_profile = BladeProfile(
    blades = blades,
    rotor_hub_radius_m = HUB_RADIUS,
    rotor_radius_m = TIP_RADIUS,
    num_blades = NUM_BLADES,
    tip_speed_ratio = TSR,
    wind_speed_mps = WIND_SPEED,
    shift = SHIFT
)

# ---------------------------------------------------- #
# -------------- SAVE BLADE PROFILE OBJ -------------- #
# ---------------------------------------------------- #
save_blade_profile_json(blade_profile, 'blade_profile_test')
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------------------------------------------- #



